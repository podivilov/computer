#!/bin/bash

# Define global variables
HOUR=$(date "+%H"); MINUTE=$(date "+%M")

# Should we run in normal mode or remind mode
if ! [[ "$1" == "--remind" ]]; then
  # Define global functions
  function ready() {
    # Get count of new messages
    NEW_MSG_COUNT=$(while (true); do ((i++)); timeout 2s /usr/bin/get_unread_message_count; if [[ "$?" -eq "0" || "$i" -ge "5" ]]; then break; fi; done)

    # Show new notifications
    if   [[    "$NEW_MSG_COUNT" -gt "0" ]]; then
      aplay -q /usr/share/computer/sounds/information.wav &
      notify-send -i mail-mark-important "Проверь почту!" "У тебя есть новые сообщения <b>($NEW_MSG_COUNT)</b>"
      thunderbird &
    elif [[ -z "$NEW_MSG_COUNT"         ]]; then
      # Check the internet connection
      ping -q -w 1 -c 1 `ip r | grep default | cut -d ' ' -f 3` &> /dev/null && ONLINE="1" || ONLINE="0"

      if [[ "$ONLINE" -eq "0" ]]; then
        aplay -q /usr/share/computer/sounds/error.wav &
        notify-send -i network-offline "Караул!" "<b>Интернета нет!</b>"
      else
        aplay -q /usr/share/computer/sounds/error.wav &
        notify-send -i error "Упс!" "<b>Что-то пошло не так...</b>"
      fi
    else
      aplay -q /usr/share/computer/sounds/nothing-interesting.wav &
      notify-send -i info "Ничего интересного..." "<b>Новых сообщений нет.</b>"
    fi
  }

  # Notify the user that we are ready to go
  aplay -q /usr/share/computer/sounds/beep.wav &

  # Tell the user that we are currently processing the data
  notify-send -i gnome-run -t 1 "Один момент..." &

  # Check if the screensaver is running
  if (xscreensaver-command -time; echo "$?" > /tmp/.xscreensaver-exit-status) | grep "non-blanked" &> /dev/null; then
    ready
  else
    xscreensaver_exit_status=$(cat /tmp/.xscreensaver-exit-status)
    if [[ "$xscreensaver_exit_status" != "255" ]]; then
      xscreensaver-command -deactivate &> /dev/null &
      ready
    else
      ready
    fi
  fi
else
  if   [[ "$HOUR" == "12" && "$MINUTE" == "00" ]]; then
    DISPLAY=":0.0" notify-send -i /usr/share/computer/icons/pora-na-obed.png "Пора на обед!" "<b>Ты поторопись\!</b>" &
    XDG_RUNTIME_DIR=/run/user/`id -u` aplay -q /usr/share/computer/sounds/alert.wav
  elif [[ "$HOUR" == "16" && "$MINUTE" == "30" ]]; then
    DISPLAY=":0.0" notify-send -i stock_appointment-reminder "Закругляйся!" "<b>Рабочий день завершён\!</b>" &
    XDG_RUNTIME_DIR=/run/user/`id -u` aplay -q /usr/share/computer/sounds/alert.wav
  fi
fi
